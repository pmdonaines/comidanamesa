{% extends 'core/base.html' %}

{% block title %}{{ title }} - Comida na Mesa{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-4 mb-4">
            <a href="{% url 'criterio_list' %}" 
                class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <div>
                <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:tracking-tight">
                    {{ title }}
                </h2>
                <p class="mt-1 text-sm text-gray-500">
                    Preencha os dados do critério de elegibilidade
                </p>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form method="post" x-data="criterioForm()" @submit="updatePreview">
        {% csrf_token %}
        
        <div class="space-y-8">
            <!-- Section 1: Informações Básicas -->
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
                <div class="px-4 py-5 sm:p-6">
                    <div class="border-b border-gray-200 pb-4 mb-6">
                        <h3 class="text-base font-semibold leading-6 text-gray-900">Informações Básicas</h3>
                        <p class="mt-1 text-sm text-gray-500">Descrição e identificação do critério</p>
                    </div>

                    <div class="space-y-6">
                        <!-- Descrição -->
                        <div>
                            <label for="descricao" class="block text-sm font-medium leading-6 text-gray-900">
                                Descrição do Critério
                                <span class="text-red-600">*</span>
                            </label>
                            <div class="mt-2">
                                <textarea id="descricao" name="descricao" rows="3" required
                                    class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-sm sm:leading-6"
                                    placeholder="Ex: Famílias em extrema vulnerabilidade social com renda per capita de até R$ 218,00">{% if criterio %}{{ criterio.descricao }}{% endif %}</textarea>
                            </div>
                            <p class="mt-2 text-sm text-gray-500">Descrição completa que aparecerá durante a validação.</p>
                        </div>

                        <!-- Categoria -->
                        <div>
                            <label for="categoria" class="block text-sm font-medium leading-6 text-gray-900 mb-2">
                                Categoria
                                <span class="text-red-600">*</span>
                            </label>
                            <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                                {% for cat in categorias %}
                                <label class="relative flex cursor-pointer rounded-lg border border-gray-300 bg-white p-4 shadow-sm focus-within:ring-2 focus-within:ring-emerald-600 hover:border-emerald-300 transition-all">
                                    <input type="radio" name="categoria" value="{{ cat.pk }}" 
                                        {% if criterio and criterio.categoria.pk == cat.pk %}checked{% endif %}
                                        class="sr-only" required
                                        @change="selectedCategory = '{{ cat.codigo }}'">
                                    <div class="flex flex-1 items-center">
                                        <div class="flex-shrink-0">
                                            <div class="flex h-10 w-10 items-center justify-center rounded-lg
                                                {% if cat.codigo == 'desenvolvimento_social' %}bg-blue-100
                                                {% elif cat.codigo == 'saude' %}bg-red-100
                                                {% elif cat.codigo == 'educacao' %}bg-purple-100
                                                {% elif cat.codigo == 'documentacao' %}bg-gray-200
                                                {% endif %}">
                                                {% if cat.codigo == 'desenvolvimento_social' %}
                                                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                                </svg>
                                                {% elif cat.codigo == 'saude' %}
                                                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                                </svg>
                                                {% elif cat.codigo == 'educacao' %}
                                                <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                                    <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
                                                </svg>
                                                {% elif cat.codigo == 'documentacao' %}
                                                <svg class="h-6 w-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <span class="block text-sm font-medium text-gray-900">{{ cat.nome }}</span>
                                            <span class="mt-1 flex items-center text-xs text-gray-500">{{ cat.descricao }}</span>
                                        </div>
                                    </div>
                                    <svg class="h-5 w-5 text-emerald-600 [input:checked~&]:block hidden" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                    </svg>
                                </label>
                                {% endfor %}
                            </div>
                            <p class="mt-3 text-sm text-gray-500">Categoria temática para agrupar e organizar este critério.</p>
                        </div>

                        <!-- Código -->
                        <div>
                            <label for="codigo" class="block text-sm font-medium leading-6 text-gray-900">
                                Código Identificador
                                <span class="text-red-600">*</span>
                            </label>
                            <div class="mt-2">
                                <input type="text" name="codigo" id="codigo" required
                                    value="{% if criterio %}{{ criterio.codigo }}{% endif %}"
                                    {% if criterio %}readonly{% endif %}
                                    class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-sm sm:leading-6 font-mono {% if criterio %}bg-gray-50{% endif %}"
                                    placeholder="renda_per_capita">
                            </div>
                            <p class="mt-2 text-sm text-gray-500">
                                {% if criterio %}
                                <span class="inline-flex items-center gap-1 text-amber-700">
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                    Código não pode ser editado após criação
                                </span>
                                {% else %}
                                Use apenas letras minúsculas, números e underscore (snake_case)
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Pontuação -->
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
                <div class="px-4 py-5 sm:p-6">
                    <div class="border-b border-gray-200 pb-4 mb-6">
                        <h3 class="text-base font-semibold leading-6 text-gray-900">Pontuação</h3>
                        <p class="mt-1 text-sm text-gray-500">Configure os pontos base e o peso multiplicador</p>
                    </div>

                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <!-- Pontos -->
                        <div>
                            <label for="pontos" class="block text-sm font-medium leading-6 text-gray-900">
                                Pontos Base
                            </label>
                            <div class="mt-2 relative">
                                <input type="number" name="pontos" id="pontos" min="0" max="100" step="1"
                                    x-model="pontos"
                                    value="{% if criterio %}{{ criterio.pontos }}{% else %}10{% endif %}"
                                    class="block w-full rounded-md border-0 py-1.5 pr-12 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-sm sm:leading-6">
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                    <span class="text-gray-500 sm:text-sm">pts</span>
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-500">Pontuação base que será multiplicada pelo peso</p>
                        </div>

                        <!-- Peso -->
                        <div>
                            <label for="peso" class="block text-sm font-medium leading-6 text-gray-900">
                                Peso (Multiplicador)
                            </label>
                            <div class="mt-2 relative">
                                <input type="number" name="peso" id="peso" min="0" max="10" step="0.1"
                                    x-model="peso"
                                    value="{% if criterio %}{{ criterio.peso }}{% else %}1.0{% endif %}"
                                    class="block w-full rounded-md border-0 py-1.5 pr-12 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-sm sm:leading-6">
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                                    <span class="text-gray-500 sm:text-sm">×</span>
                                </div>
                            </div>
                            <p class="mt-2 text-sm text-gray-500">Multiplicador para dar mais importância ao critério</p>
                        </div>
                    </div>

                    <!-- Preview Expandido -->
                    <div class="mt-6 p-6 rounded-xl bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 border border-emerald-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-sm font-semibold text-gray-700 mb-1">Pontuação Final</h4>
                                <p class="text-xs text-gray-600">Cálculo: Pontos × Peso</p>
                            </div>
                            <div class="text-right">
                                <div class="inline-flex items-baseline gap-2 font-mono text-sm text-gray-700">
                                    <span x-text="pontos" class="font-semibold text-emerald-700">{{ criterio.pontos|default:10 }}</span>
                                    <span class="text-gray-400">×</span>
                                    <span x-text="peso" class="font-semibold text-emerald-700">{{ criterio.peso|default:'1.0' }}</span>
                                    <span class="text-gray-400">=</span>
                                </div>
                                <div class="mt-2">
                                    <span class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-2xl font-bold text-white shadow-lg">
                                        <span x-text="(pontos * peso).toFixed(1)">{{ criterio.pontos|default:10 }}</span>
                                        <span class="text-sm font-normal opacity-90">pontos</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Condições de Aplicação -->
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
                <div class="px-4 py-5 sm:p-6">
                    <div class="border-b border-gray-200 pb-4 mb-6">
                        <h3 class="text-base font-semibold leading-6 text-gray-900">Condições de Aplicação</h3>
                        <p class="mt-1 text-sm text-gray-500">Defina quando este critério deve ser aplicado. Se a condição não for atendida, o critério será ignorado.</p>
                    </div>

                    <div class="space-y-4">
                        <!-- Aplica-se a famílias sem crianças -->
                        <div class="relative flex items-start">
                            <div class="flex h-6 items-center">
                                <input id="aplica_se_a_sem_criancas" name="aplica_se_a_sem_criancas" type="checkbox"
                                    {% if not criterio or criterio.aplica_se_a_sem_criancas %}checked{% endif %}
                                    class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-600">
                            </div>
                            <div class="ml-3 text-sm leading-6">
                                <label for="aplica_se_a_sem_criancas" class="font-medium text-gray-900">Aplica-se a famílias sem crianças?</label>
                                <p class="text-gray-500">Se desmarcado, este critério NÃO será exigido para famílias que não possuem crianças (menores de 18 anos).</p>
                            </div>
                        </div>

                        <!-- Aplica-se a RF homem -->
                        <div class="relative flex items-start">
                            <div class="flex h-6 items-center">
                                <input id="aplica_se_a_rf_homem" name="aplica_se_a_rf_homem" type="checkbox"
                                    {% if not criterio or criterio.aplica_se_a_rf_homem %}checked{% endif %}
                                    class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-600">
                            </div>
                            <div class="ml-3 text-sm leading-6">
                                <label for="aplica_se_a_rf_homem" class="font-medium text-gray-900">Aplica-se a RF homem?</label>
                                <p class="text-gray-500">Se desmarcado, este critério NÃO será exigido se o Responsável Familiar for do sexo masculino.</p>
                            </div>
                        </div>

                        <!-- Aplica-se a famílias unipessoais -->
                        <div class="relative flex items-start">
                            <div class="flex h-6 items-center">
                                <input id="aplica_se_a_unipessoais" name="aplica_se_a_unipessoais" type="checkbox"
                                    {% if not criterio or criterio.aplica_se_a_unipessoais %}checked{% endif %}
                                    class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-600">
                            </div>
                            <div class="ml-3 text-sm leading-6">
                                <label for="aplica_se_a_unipessoais" class="font-medium text-gray-900">Aplica-se a famílias unipessoais?</label>
                                <p class="text-gray-500">Se desmarcado, este critério NÃO será exigido para famílias compostas por apenas uma pessoa.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Condições Avançadas -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="text-sm font-medium text-gray-900 mb-4">Condições Avançadas (Baseadas nos Membros)</h4>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                            <!-- Idade Mínima -->
                            <div>
                                <label for="idade_minima" class="block text-sm font-medium leading-6 text-gray-900">Idade Mínima</label>
                                <div class="mt-2">
                                    <input type="number" name="idade_minima" id="idade_minima" min="0" max="120"
                                        value="{{ criterio.idade_minima|default:'' }}"
                                        class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-sm sm:leading-6">
                                </div>
                            </div>

                            <!-- Idade Máxima -->
                            <div>
                                <label for="idade_maxima" class="block text-sm font-medium leading-6 text-gray-900">Idade Máxima</label>
                                <div class="mt-2">
                                    <input type="number" name="idade_maxima" id="idade_maxima" min="0" max="120"
                                        value="{{ criterio.idade_maxima|default:'' }}"
                                        class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-sm sm:leading-6">
                                </div>
                            </div>

                            <!-- Sexo Necessário -->
                            <div>
                                <label for="sexo_necessario" class="block text-sm font-medium leading-6 text-gray-900">Sexo Necessário</label>
                                <div class="mt-2">
                                    <select id="sexo_necessario" name="sexo_necessario"
                                        class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-sm sm:leading-6">
                                        <option value="">Qualquer</option>
                                        <option value="1" {% if criterio.sexo_necessario == '1' %}selected{% endif %}>Masculino</option>
                                        <option value="2" {% if criterio.sexo_necessario == '2' %}selected{% endif %}>Feminino</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <p class="mt-2 text-xs text-gray-500">
                            Se preenchido, o critério só será aplicado se houver pelo menos um membro na família que atenda a <strong>todas</strong> as condições avançadas especificadas (idade e sexo).
                        </p>
                    </div>
                </div>
            </div>

            <!-- Section 4: Status -->
            <div class="bg-white shadow-sm ring-1 ring-gray-900/5 sm:rounded-xl">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex items-start">
                        <div class="flex h-6 items-center">
                            <input id="ativo" name="ativo" type="checkbox"
                                {% if not criterio or criterio.ativo %}checked{% endif %}
                                class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-600">
                        </div>
                        <div class="ml-3">
                            <label for="ativo" class="text-sm font-medium text-gray-900">Critério Ativo</label>
                            <p class="text-sm text-gray-500">Critérios inativos não serão incluídos em novas validações. Use isso para desativar temporariamente um critério sem excluí-lo.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex items-center justify-end gap-x-4">
            <a href="{% url 'criterio_list' %}" 
                class="rounded-md px-3.5 py-2.5 text-sm font-semibold text-gray-700 hover:text-gray-900 hover:bg-gray-100 transition-colors">
                Cancelar
            </a>
            <button type="submit"
                class="inline-flex items-center gap-2 rounded-md bg-emerald-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 transition-all">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                {{ button_text }}
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('criterioForm', () => ({
        pontos: '{{ criterio.pontos|default:10 }}',
        peso: '{{ criterio.peso|default:1.0 }}',
        selectedCategory: '{% if criterio %}{{ criterio.categoria.codigo }}{% endif %}',
        
        get pontuacaoTotal() {
            return (this.pontos * this.peso).toFixed(1);
        }
    }));
});
</script>
{% endblock %}
